<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8" />
	<!-- Load plotly.js into the DOM -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@1.5.0/dist/d3-scale-chromatic.min.js"></script>
	<script src='https://cdn.plot.ly/plotly-2.34.0.min.js'></script>
    <script 
      src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.20/fetch.min.js" 
      integrity="sha512-5vzl35V/cPSXliPbZtxHY0Q6cfYFd2Qld79+d7wLPbOxnKeCHH/LmlMD8aYl0ZN5VZPFM2FnKiAjoNJ2k3vrEg==" 
      crossorigin="anonymous" 
      referrerpolicy="no-referrer"
      type="module"
    ></script>

    <link rel="stylesheet" type="text/css" href="static/style.css">
    <link rel="stylesheet" type="text/css" href="static/dropdown.css">

</head>

<body>
  <div>
      <div id="activityPlot"></div>
  </div>
  <div id="colorLegend">
     <div id="colorLegend">
    <div class="color-box"">
        <div class="text-top-left">Calories in</div>
        <div class="value-center">100</div>
    </div>
    <div class="color-box"">
        <div class="text-top-left">Calories out</div>
        <div class="value-center">✔</div>
    </div>
    <div class="color-box"">
        <div class="text-top-left">Protein</div>
        <div class="value-center">✔</div>
    </div>
</div>
  </div>
  <div></div>
    <div id="plotControls">
        <button onclick="toggleMarkers()">Toggle Markers</button>
        <button onclick="toggleLines()">Toggle Lines</button>
      </div>
    <div id="caloriesPlotContainer">

      <div id="customSelectorContainer">
        <div id="customSelector" onclick="toggleDropdown(event)">
          <span id="currentSelection">Calories</span>
        </div>
        <ul id="customDropdown" class="hidden">
          <li><input type="checkbox" onchange="updateSelected('calories in', this)" checked>Calories in</li>
          <li><input type="checkbox" onchange="updateSelected('calories out', this)" checked>Calories out</li>
          <li><input type="checkbox" onchange="updateSelected('proteins', this)">Proteins</li>
          <li><input type="checkbox" onchange="updateSelected('carbs', this)">Carbs</li>
          <li><input type="checkbox" onchange="updateSelected('fat', this)">Fat</li>
          <li><input type="checkbox" onchange="updateSelected('sugar', this)">Sugar</li>
          <li><input type="checkbox" onchange="updateSelected('starch', this)">Starch</li>
          <li><input type="checkbox" onchange="updateSelected('fiber', this)">Fiber</li>
          <li><input type="checkbox" onchange="updateSelected('active_time', this)">Active time</li>
          <li><input type="checkbox" onchange="updateSelected('steps', this)">Steps</li>
          <li><input type="checkbox" onchange="updateSelected('inactivity_stamps', this)">Inactivity stamps</li>
          <li><input type="checkbox" onchange="updateSelected('sleep_time', this)">Sleep time</li>
        </ul>
      </div>
      <div id="caloriesPlot"></div>
    </div>
  </div>
  <div>
      <div id="macroNutrientsPlot"></div>
  </div>
</body>


<script>

let caloriesData = null;
let selectedVariables = ["calories in", "calories out"];

let showMarkers = true;
let showLines = true;

function toggleMarkers() {
    showMarkers = !showMarkers;
    plotCaloriesData();  // Redraw the plot with updated markers
}

function toggleLines() {
    showLines = !showLines;
    plotCaloriesData();  // Redraw the plot with updated lines
}

function updateSelected(variable, checkbox) {
    if (checkbox.checked) {
        if (!selectedVariables.includes(variable)) {
            selectedVariables.push(variable);
        }
    } else {
        selectedVariables = selectedVariables.filter(item => item !== variable);
    }
    plotCaloriesData(); // Example call
}

function toggleDropdown(event) {
    const dropdown = document.getElementById('customDropdown');
    if (!dropdown) {
        console.error("Dropdown element not found!");
        return;
    }

    dropdown.classList.toggle('hidden');
    dropdown.classList.toggle('visible');
}

function changeYaxis(event, yAxis) {
    // Logic to update the plot with the selected yAxis
    //plotCaloriesData(yAxis);
    const currentSelection = document.getElementById('currentSelection');
    currentSelection.textContent = yAxis;
    toggleDropdown(event);  // Hide dropdown after selection
}

async function getData(url) {
  try {
    const options = { method: 'GET' };
    const response = await fetch(url, options);
    
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    
    const data = await response.json();
    
    return data;
  } catch (error) {
    console.error('Error fetching data:', error);
  }
}

async function plotActivityData() {
    const data = await getData("http://127.0.0.1:8080/activity");
    if (data) {
        const trace = {
            x: data.dates,
            y: data.steps,
            mode: 'lines+markers',
            type: 'scatter',
            name: 'Steps'
        };

        const layout = {
            title: 'Daily Steps Over Time',
            xaxis: { title: 'Date', type: 'date' },
            yaxis: { title: 'Steps' }
        };

        Plotly.newPlot('activityPlot', [trace], layout);
    }
}

function plotCaloriesData() {
    if (!caloriesData) {
        console.error("No data");
        return;
    }
    
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    let traces = [];
    let traceIndices = [];

    selectedVariables.forEach((variable, index) => {
        const yValues = caloriesData[variable];
        const averageValue = yValues.reduce((sum, value) => sum + value, 0) / yValues.length;
        
        const color = colorScale(index); 

        const trace = {
            x: caloriesData.date,
            y: yValues,
            mode: 'lines+markers',
              line: {
                color: color,
                width: 1
            },
            marker: {
                color: color
            },
            name: variable.charAt(0).toUpperCase() + variable.slice(1)
        };

        const traceAverage = {
            x: [caloriesData.date[0], caloriesData.date[caloriesData.date.length - 1]],
            y: [averageValue, averageValue],
            mode: 'lines',
            line: { color: color, dash: 'dashdot' },
            name: `Average ${variable.charAt(0).toUpperCase() + variable.slice(1)}: ${averageValue.toFixed(2)}`
        };

        traces.push(trace);
        traceIndices.push(traces.length - 1);
        traces.push(traceAverage);
    });

    var layout = {
        xaxis: { title: 'Date', type: 'date' },
        plot_bgcolor:"31363F",
        paper_bgcolor:"#222831",
        font: {
          color: '#EEEEEE',
          family:'Courier New, monospace'
        },
        updatemenus: [{
            buttons: [
                {
                    method: 'restyle',
                    args: ['mode', 'lines+markers', traceIndices],
                    label: 'Lines + Markers'
                },
                {
                    method: 'restyle',
                    args: ['mode', 'lines', traceIndices],
                    label: 'Lines Only'
                },
                {
                    method: 'restyle',
                    args: ['mode', 'markers', traceIndices],
                    label: 'Markers Only'
                }
            ],
            direction: 'down',
            showactive: true,
            x: 0.1,
            xanchor: 'left',
            y: 1.15,
            yanchor: 'top'
        }]
    };
    const options = {displaylogo: false};

    Plotly.newPlot('caloriesPlot', traces, layout, options);
}

function plotMacroNutrients() {
    const macroNutrients = ["carbs", "proteins", "fat"];
    var values = [];
    macroNutrients.forEach(variable => {
        const yValues = caloriesData[variable];
        const averageValue = yValues.reduce((sum, value) => sum + value, 0) / yValues.length;
        values.push(averageValue);
    })

    var data = [{
        values: values,
        labels: macroNutrients,
        type: 'pie'
    }];

    var layout = {
        height: 400,
        width: 500,
        plot_bgcolor:"31363F",
        paper_bgcolor:"#222831",
        font: {
          color: '#EEEEEE',
          family:'Courier New, monospace'
        },
    };

    Plotly.newPlot('macroNutrientsPlot', data, layout);
}


async function getCaloriesData() {
    caloriesData = await getData("http://127.0.0.1:8080/calories");
    plotCaloriesData();
    plotMacroNutrients()
}

//function setupEventListeners() {
//    const customSelector = document.getElementById('customSelector');
//    if (customSelector) {
//        customSelector.addEventListener('click', toggleDropdown);
//        console.log('Event listener added to customSelector');
//    } else {
//        console.error("Custom selector element not found!");
//    }
//}

async function initialize() {
    await getCaloriesData();
}

document.addEventListener('DOMContentLoaded', function() {
    initialize();
});
</script>

</html>